<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- **ç»ˆæä¼˜åŒ–**: å½»åº•ç¦ç”¨ç¼©æ”¾ï¼Œå®ç°åŸç”ŸAppä½“éªŒ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>Maimai æ­Œæ›²è¯†åˆ«</title>

    <!-- **æ ¸å¿ƒä¿®æ”¹**: PWA å’Œ iOS å…¨å±é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Maimai Scan">

    <style>
        /* --- **ç»ˆæå½¢æ€é”å®š**: å½»åº•æ ¹é™¤æ¨ªå‘æ»šåŠ¨ --- */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        /* --- å…¨å±€é‡ç½®å’ŒåŸºç¡€æ ·å¼ --- */
        :root {
            --primary-color: #1877f2;
            --background-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #333;
            --text-light: #888;
            --accent-green: #42b72a;
            --accent-red: #d93025;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            /* **ç»ˆæå½¢æ€é”å®š**: å½»åº•ç¦æ­¢æ°´å¹³æ»šåŠ¨ */
            overflow-x: hidden;
        }

        /* --- ä¸»åº”ç”¨å®¹å™¨ --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%; /* å¼ºåˆ¶å®¹å™¨å®½åº¦ä¸º100% */
            overflow-x: hidden; /* å†æ¬¡ç¡®ä¿å®¹å™¨æœ¬èº«ä¸æº¢å‡º */
        }

        /* --- é¡µé¢å†…å®¹åŒº --- */
        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }
        .page {
            display: none; /* é»˜è®¤æ‰€æœ‰é¡µé¢éƒ½éšè— */
            animation: fadeIn 0.3s ease-in-out;
        }
        .page.active {
            display: block; /* activeçš„é¡µé¢æ‰æ˜¾ç¤º */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- åº•éƒ¨å¯¼èˆªæ  --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--container-bg);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.2s;
            flex-grow: 1;
            height: 100%;
        }
        .nav-button.active {
            color: var(--primary-color);
        }
        .nav-button svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        /* --- æ‰«æé¡µé¢å’Œç»“æœé¡µé¢çš„ç‰¹å®šæ ·å¼ --- */
        .scan-container, .result-container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        h1 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
        }
        .upload-label {
            display: inline-block;
            background-color: var(--accent-green);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .upload-label:hover {
            background-color: #36a420;
        }
        #loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1.5s linear infinite;
            display: none;
            margin: 30px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: var(--accent-red);
            font-weight: bold;
        }
        .prompt-text {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 15px;
        }
        #result-table {
            width:100%; 
            border-collapse: collapse;
            text-align: left;
            margin-top: 20px;
        }
        /* --- å…¨æ–°UIé‡æ„: ç»“æœå±•ç¤ºé¡µæ ·å¼ --- */
        .song-details-container {
            background: linear-gradient(180deg, #f4f3ff 0%, #ffffff 100%);
            padding: 15px;
            border-radius: 12px;
        }
        .song-header {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .song-header .cover {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            flex-shrink: 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .song-header .info {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-width: 0;
        }
        .song-header .title-id {
            font-size: 12px;
            color: #9c27b0;
        }
        .song-header .title {
            font-size: 20px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .favorite-btn {
            position: absolute;
            /* **V5ä¿®æ­£**: ç§»åŠ¨åˆ°çˆ¶å®¹å™¨å³ä¸Šè§’ */
            top: 10px;
            right: 10px;
            font-size: 28px;
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s, transform 0.2s;
            z-index: 1; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
        }
        .favorite-btn.favorited {
            color: #ffc107;
            transform: scale(1.2);
        }
        .song-header .basic-info {
            font-size: 12px;
            color: var(--text-light);
        }
        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .difficulty-selector button {
            padding: 8px 5px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background-color: #f5f5f5;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        .difficulty-selector button.active {
            color: white;
            font-weight: bold;
            border-width: 2px;
        }
        .difficulty-selector button.active.basic { background-color: #2dbd64; border-color: #2dbd64; }
        .difficulty-selector button.active.advanced { background-color: #f9a825; border-color: #f9a825; }
        .difficulty-selector button.active.expert { background-color: #f44336; border-color: #f44336; }
        .difficulty-selector button.active.master { background-color: #9c27b0; border-color: #9c27b0; }
        .difficulty-selector button.active.remaster { background-color: #ab47bc; border-color: #ab47bc; }

        .details-card {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .details-grid .item .label, .notes-grid .item .label {
            font-size: 12px;
            color: var(--text-light);
        }
        .details-grid .item .value, .notes-grid .item .value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            text-align: center;
            margin-top: 15px;
        }
        .player-score-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative; /* **V5ä¿®æ­£**: ä½œä¸ºæ”¶è—æŒ‰é’®çš„å®šä½çˆ¶çº§ */
        }
        .player-score-card .score-value {
            font-size: 28px;
            font-weight: bold;
            color: #9c27b0;
        }
        /* --- å…¨æ–°UIé‡æ„: åˆ†æ•°è¯¦æƒ…è¡¨ --- */
        .score-table-container {
            margin-top: 15px;
            overflow-x: auto; /* å…è®¸è¡¨æ ¼åœ¨å°å±å¹•ä¸Šæ¨ªå‘æ»šåŠ¨ */
        }
        .score-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            text-align: center;
        }
        .score-table th, .score-table td {
            border: 1px solid #e0e0e0;
            padding: 8px 4px;
        }
        .score-table th {
            background-color: #8c52ff;
            color: white;
            font-weight: bold;
        }
        .score-table .difficulty-cell {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .score-table .player-score-highlight {
            background-color: #fff9c4;
            font-weight: bold;
        }
        .score-table .gain {
            color: var(--accent-green);
            font-size: 10px;
        }
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .action-buttons button, .action-buttons a {
            display: block;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background-color: #9c27b0;
            color: white;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }
        .action-buttons button:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }

        /* --- **å†å²è®°å½•é¡µé¢æ ·å¼** --- */
        #history-list {
            list-style: none;
            padding: 0;
        }
        .history-item {
            background-color: var(--container-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .history-item-info {
            /* **ç»ˆæUIå¥å£®æ€§ä¿®å¤**: é™åˆ¶å®½åº¦å¹¶å¯ç”¨flexå¸ƒå±€ */
            flex-grow: 1;
            min-width: 0; /* å…è®¸flex itemæ”¶ç¼© */
            font-size: 14px;
        }
        .history-item-info .title {
            font-weight: bold;
            color: var(--text-color);
            /* **ç»ˆæUIå¥å£®æ€§ä¿®å¤**: åº”ç”¨æ–‡æœ¬æº¢å‡ºçœç•¥æ•ˆæœ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-info .time {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }
        .history-item-actions {
            /* **ç»ˆæUIå¥å£®æ€§ä¿®å¤**: é˜²æ­¢æŒ‰é’®åŒºåŸŸè¢«å‹ç¼© */
            flex-shrink: 0;
        }
        .history-item-actions button {
            background: none;
            border: 1px solid #ddd;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 8px;
            font-size: 12px;
        }
        .history-item-actions .delete-btn {
            color: var(--accent-red);
            border-color: var(--accent-red);
        }
        #clear-history-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--accent-red);
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 16px;
        }

        /* --- **è¯¦æƒ…å¼¹çª— (Modal) æ ·å¼** --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 85%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        /* --- **æ–°å¢**: å°é¢å›¾ç‰‡æ ·å¼ --- */
        .song-cover {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 8px;
            margin: 0 auto 20px auto;
            display: block;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .history-item-cover {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            margin-right: 15px;
            object-fit: cover;
        }
        /* --- **æ–°å¢**: ä¸»é¡µæœç´¢æ¡†æ ·å¼ --- */
        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }
        /* --- **æ–°å¢**: ä¸»é¡µRatingæ˜¾ç¤ºæ ·å¼ --- */
        .home-rating-container {
            /* **ç»ˆææ”¹é€ **: ç§»é™¤é™æ€èƒŒæ™¯ï¼Œç”±JSåŠ¨æ€æ§åˆ¶ */
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px; /* **ç»ˆææ”¹é€ **: è°ƒæ•´ä¸ºåœ¨æœç´¢æ¡†ä¸‹æ–¹æ˜¾ç¤º */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            /* **ç»ˆæä¿®å¤**: ç§»é™¤å¯¼è‡´æ ·å¼åº”ç”¨å¤±è´¥çš„transitionå±æ€§ */
        }
        .home-rating-container .label {
            font-size: 16px;
            opacity: 0.8;
        }
        .home-rating-container .value {
            font-size: 36px;
            font-weight: bold;
            margin-top: 5px;
        }
        #search-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px 0 0 8px;
            font-size: 16px;
        }
        #search-button {
            padding: 0 20px;
            border: 1px solid var(--primary-color);
            background-color: var(--primary-color);
            color: white;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-size: 16px;
        }
        /* --- **æ–°å¢**: ç™»å½•å¼¹çª—æ ·å¼ --- */
        #login-modal .modal-content {
            margin-top: 25%;
        }
        .login-form input {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .login-form button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .security-warning {
            font-size: 12px;
            color: var(--text-light);
            background-color: #f0f2f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: left;
        }
        #logout-button, #refresh-profile-btn {
            width: calc(50% - 30px);
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        #logout-button {
            background-color: var(--accent-red);
            color: white;
            float: right;
            margin-right: 20px;
        }
        #refresh-profile-btn {
            background-color: var(--primary-color);
            color: white;
            float: left;
            margin-left: 20px;
        }

        /* B50 Button on Home Page */
        .rating-wrapper {
            position: relative;
        }
        #b50-button-home {
            position: absolute;
            bottom: 10px;
            right: 10px; /* ä¿®æ”¹ä¸ºå³å¯¹é½ */
            background-color: rgba(0, 0, 0, 0.4);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .home-interactive-zone {
            display: grid;
            /* **ç•™è¨€æ¿æ”¹é€ **: æ”¹ä¸ºä¸¤åˆ—å¸ƒå±€ */
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        #favorites-button-home, #feedback-button-home {
            display: flex;
            align-items: center;
            justify-content: center;
            /* **ç•™è¨€æ¿æ”¹é€ **: å®½åº¦è‡ªåŠ¨æ’‘æ»¡Gridå•å…ƒæ ¼ */
            width: 100%; 
            background-color: var(--container-bg);
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 10px; /* **ç•™è¨€æ¿æ”¹é€ **: å¢åŠ å†…è¾¹è· */
            /* é«˜åº¦å°†ç”±JSåŠ¨æ€è®¾å®š */
        }
        #b50-button-home:hover {
            background-color: rgba(0, 0, 0, 0.6);
        }

        /* --- B50 Modal Styles --- */
        #b50-modal .modal-content {
            width: 95%;
            max-width: 800px;
            margin: 5% auto;
        }
        .b50-grid-class {
            display: grid;
            /* **ç»ˆæè‡ªé€‚åº”ä¿®æ­£**: é‡‡ç”¨çœŸæ­£çš„è‡ªé€‚åº”ç½‘æ ¼ï¼Œå…è®¸é¡¹ç›®æ”¶ç¼©ä»¥é€‚åº”å°å±å¹• */
            grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .b50-item {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            /* **ç»ˆæå½¢æ€ä¿®æ­£**: åº”ç”¨å®Œæ•´çš„ã€3pxå®½çš„è¾¹æ¡† */
            border: 3px solid transparent;
            cursor: pointer; /* **æ–°å¢**: å¢åŠ ç‚¹å‡»æ‰‹åŠ¿ */
        }
        .b50-item img {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }
        .b50-item .title {
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
            /* **ç»ˆæå½¢æ€å¼ºåˆ¶ä¸¤è¡Œ**: å¼ºåˆ¶å®¹å™¨ä¸ºä¸¤è¡Œé«˜åº¦ï¼Œå¤šä½™çœç•¥ï¼Œä¸è¶³ç•™ç™½ */
            height: 2.4em; /* å¼ºåˆ¶ä¸¤è¡Œé«˜åº¦ (1.2em * 2) */
            line-height: 1.2em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            text-overflow: ellipsis;
            word-break: break-all;
        }
        /* **ç»ˆæå½¢æ€æ”¹é€ **: å…¨æ–°B50é¡¹ç›®æ ·å¼ */
        .b50-item .achievements {
            font-size: 8px; /* **ç»ˆæå½¢æ€é”å®š**: ç»§ç»­ç¼©å°å­—ä½“ */
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }
        .b50-item .stats, .b50-item .dx-score {
            font-size: 11px;
            color: #555;
            margin-top: 2px;
        }
        .b50-item .rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .b50-item-inner {
            position: relative;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- é¡µé¢å†…å®¹åŒº -->
        <main class="content">
            <!-- ä¸»é¡µ -->
            <div id="page-home" class="page">
                <div class="search-bar">
                    <input type="search" id="search-input" placeholder="è¾“å…¥æ­Œæ›²åç§°æˆ–ID...">
                    <button id="search-button">æœç´¢</button>
                </div>
            <!-- **å®‡å®™ç»ˆæä¿®æ­£**: é‡‡ç”¨JSåŠ¨æ€ç­‰é«˜æ–¹æ¡ˆ -->
            <div class="home-interactive-zone">
                <!-- **ç•™è¨€æ¿æ”¹é€ **: å°†Ratingå¡ç‰‡ç§»å‡ºGridï¼Œä½¿å…¶èƒ½æ¨ªè·¨ä¸¤åˆ— -->
                <div class="rating-wrapper" style="grid-column: 1 / -1;">
                    <div id="home-rating-display" class="home-rating-container" style="display: none;">
                        <div class="label">Player Rating</div>
                        <div class="value">...</div>
                        <button id="b50-button-home">æŸ¥è¯¢B50</button>
                    </div>
                </div>
                <!-- **ç•™è¨€æ¿æ”¹é€ **: ä¸¤ä¸ªæŒ‰é’®å¹¶æ’æ”¾ç½® -->
                <button id="favorites-button-home">â­ æˆ‘çš„æ”¶è—</button>
                <button id="feedback-button-home">ğŸ“ ç•™è¨€åé¦ˆ</button>
            </div>
                <div id="home-loader" style="display: none; margin: 30px auto;"></div>
                <!-- æœç´¢ç»“æœå°†æ˜¾ç¤ºåœ¨å¼¹çª—ä¸­ -->
            </div>

            <!-- æ‰«æ/ç»“æœé¡µ -->
            <div id="page-scan" class="page">
                <div class="scan-container">
                    <h1>Maimai æ­Œæ›²è¯†åˆ«</h1>
                    <form id="upload-form" style="display: none;">
                        <input id="file-upload" type="file" name="file" accept="image/*" capture="environment">
                    </form>
                    <div id="loader"></div>
                    <div id="result-display"></div>
                    <p id="scan-prompt" class="prompt-text">ç‚¹å‡»ä¸‹æ–¹ä¸­é—´çš„â€œæ‰«æâ€æŒ‰é’®å¼€å§‹è¯†åˆ«</p>
                </div>
            </div>

            <!-- ä¸ªäººä¸»é¡µ -->
            <div id="page-profile" class="page">
                <h1>æˆ‘çš„èµ„æ–™</h1>
                <div id="profile-container" class="result-container" style="text-align: left; padding: 20px;">
                    <!-- ä¸ªäººèµ„æ–™å°†ç”±JSåŠ¨æ€å¡«å…… -->
                    <p>æ­£åœ¨åŠ è½½...</p>
                </div>
                <div style="overflow: hidden; width: 100%;"> <!-- æ¸…é™¤æµ®åŠ¨ -->
                    <button id="refresh-profile-btn">æ›´æ–°æ•°æ®</button>
                    <button id="logout-button">å®‰å…¨ç™»å‡º</button>
                </div>
            </div>

            <!-- **æ–°å¢**: å†å²è®°å½•é¡µé¢ -->
            <div id="page-history" class="page">
                <h1>å†å²è®°å½•</h1>
                <ul id="history-list">
                    <!-- å†å²è®°å½•å°†ç”±JSåŠ¨æ€å¡«å…… -->
                </ul>
                <button id="clear-history-btn" style="display: none;">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
            </div>
        </main>

        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <nav class="bottom-nav">
            <button class="nav-button" data-page="home">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                <span>ä¸»é¡µ</span>
            </button>
            <button class="nav-button" data-page="scan">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm-2 4h4v-1.09c-1.12-.23-2.88-.23-4 0V16zm10-2c0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6 6 2.69 6 6zm-2 0c0-2.21-1.79-4-4-4s-4 1.79-4 4 1.79 4 4 4 4-1.79 4-4zM3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm-2 16H7V3h14v14z"/></svg>
                <span>æ‰«æ</span>
            </button>
            <button class="nav-button" data-page="history">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8H12z"/></svg>
                <span>å†å²</span>
            </button>
            <button class="nav-button" data-page="profile">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <span>æˆ‘çš„</span>
            </button>
        </nav>
    </div>

    <!-- **æ–°å¢**: å†å²è¯¦æƒ…å¼¹çª— -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="modal-result-display"></div>
        </div>
    </div>

    <!-- **æ–°å¢**: ç™»å½•å¼¹çª— -->
    <div id="login-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>ç™»å½• Diving-Fish</h3>
            <form id="login-form" class="login-form">
                <input type="text" id="username-input" placeholder="Diving-Fish ç”¨æˆ·å" required>
                <input type="password" id="password-input" placeholder="å¯†ç " required>
                <button type="submit">ç™»å½•</button>
            </form>
            <p id="login-error" class="error" style="display: none;"></p>
            <div class="security-warning">
                <strong>å®‰å…¨æç¤º:</strong> æ‚¨æ­£åœ¨æä¾›Diving-Fishçš„ç”¨æˆ·åå’Œå¯†ç ã€‚æˆ‘ä»¬ä¸ä¼šå­˜å‚¨æ‚¨çš„å¯†ç ï¼Œä»…ç”¨äºå•æ¬¡ç™»å½•éªŒè¯ã€‚è¯·ç¡®ä¿ä¸è¦åœ¨å…¬å…±åœºåˆæ“ä½œï¼Œå¹¶é¿å…ä½¿ç”¨å¸¸ç”¨å¯†ç ã€‚
            </div>
            <div style="text-align: center; margin-top: 20px; font-size: 14px;">
                <a href="https://www.diving-fish.com/maimaidx/prober/" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color); text-decoration: none;">
                    æ²¡æœ‰æ³¨å†Œæ°´é±¼ï¼Ÿ
                </a>
            </div>
        </div>
    </div>

    <!-- **ç»ˆæäº¤äº’å‡çº§**: è‡ªå®šä¹‰æç¤ºå¼¹çª— -->
    <div id="custom-alert-modal" class="modal" style="display: none;">
        <div class="modal-content" style="text-align: center; max-width: 300px;">
            <h3 id="custom-alert-title" style="margin-top: 0;">æç¤º</h3>
            <p id="custom-alert-message" style="margin: 20px 0; font-size: 16px;"></p>
            <button id="custom-alert-close-btn" style="width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">ç¡®å®š</button>
        </div>
    </div>

    <!-- B50 Modal -->
    <div id="b50-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Best 50</h2>
            <div id="b50-loader" style="display: none; border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1.5s linear infinite; margin: 30px auto;"></div>
            <div id="b50-container" style="display: none;">
                <h3>Best 35 (æ—§ç‰ˆæœ¬ä¹æ›²)</h3>
                <div id="b35-grid" class="b50-grid-class"></div>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <h3>Best 15 (æ–°ç‰ˆæœ¬ä¹æ›²)</h3>
                <div id="b15-grid" class="b50-grid-class"></div>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favorites-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>æˆ‘çš„æ”¶è—</h2>
            <div id="favorites-list-container">
                <!-- Favorite songs will be listed here -->
            </div>
        </div>
    </div>

    <!-- **ç•™è¨€æ¿æ”¹é€ **: æ–°å¢åé¦ˆå¼¹çª— -->
    <div id="feedback-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>ç•™è¨€åé¦ˆ</h2>
            <form id="feedback-form">
                <div style="margin-bottom: 15px;">
                    <label for="feedback-type" style="display: block; margin-bottom: 5px;">åé¦ˆç±»å‹:</label>
                    <select id="feedback-type" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="suggestion">åŠŸèƒ½å»ºè®®</option>
                        <option value="bug">Bugåé¦ˆ</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="feedback-content" style="display: block; margin-bottom: 5px;">è¯¦ç»†å†…å®¹:</label>
                    <textarea id="feedback-content" rows="6" required style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; resize: vertical;"></textarea>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="feedback-contact" style="display: block; margin-bottom: 5px;">è”ç³»æ–¹å¼ (å¯é€‰):</label>
                    <input type="text" id="feedback-contact" placeholder="QQ / é‚®ç®± / Bç«™ç”¨æˆ·å" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                </div>
                <button type="submit" id="submit-feedback-btn" style="width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">æäº¤åé¦ˆ</button>
            </form>
        </div>
    </div>

    <script>
        // --- **ç»ˆæç¼“å­˜æ¶æ„**: æœ¬åœ°æ­Œæ›²æ•°æ®åº“ä¸æ”¶è—å¤¹å¸®åŠ©å‡½æ•° ---
        const SONG_DB_KEY = 'maimaiSongDatabase';
        const FAVORITES_KEY = 'maimaiFavorites';

        function getSongDatabase() {
            return JSON.parse(localStorage.getItem(SONG_DB_KEY) || '{}');
        }

        function getSongFromDatabase(songId) {
            const db = getSongDatabase();
            return db[songId] || null;
        }

        function getFavorites() {
            return JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
        }

        function saveFavorites(favorites) {
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
        }

        function isFavorited(songId) {
            return getFavorites().includes(songId.toString());
        }

        function toggleFavorite(songId, buttonElement) {
            let favorites = getFavorites();
            const songIdStr = songId.toString();
            const index = favorites.indexOf(songIdStr);

            if (index > -1) {
                favorites.splice(index, 1); // Unfavorite
                buttonElement.classList.remove('favorited');
            } else {
                favorites.unshift(songIdStr); // Favorite
                buttonElement.classList.add('favorited');
            }
            saveFavorites(favorites);
        }

        // **ç»ˆæç¼“å­˜æ¶æ„ä¿®å¤**: æ–°å¢ä¸€ä¸ªä¸“é—¨ç”¨äºä¿å­˜æ•´ä¸ªæ­Œæ›²æ•°æ®æ•°ç»„çš„å‡½æ•°
        function saveSongArrayToDatabase(songDataArray) {
            // ç¡®ä¿æˆ‘ä»¬æœ‰æœ‰æ•ˆçš„æ•°æ®
            if (!songDataArray || songDataArray.length === 0) return;
            
            // ä»æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ è·å–ID
            const songId = songDataArray[0].id;
            if (!songId) {
                console.error("[ç¼“å­˜å†™å…¥å¤±è´¥] æ­Œæ›²æ•°æ®ç¼ºå°‘ID:", songDataArray);
                return;
            }

            const db = getSongDatabase();
            // å°†æ•´ä¸ªæ•°ç»„å­˜å…¥æ•°æ®åº“ï¼Œé”®ä¸ºæ­Œæ›²ID
            db[songId] = songDataArray;
            localStorage.setItem(SONG_DB_KEY, JSON.stringify(db));
            console.log(`[ç¼“å­˜å†™å…¥] æ­Œæ›²ID: ${songId} (${songDataArray[0].basic_info.title}) çš„å®Œæ•´æ•°æ®å·²ä¿å­˜ã€‚`);
        }

        // --- DOMå…ƒç´ è·å– ---
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-button');
        const fileInput = document.getElementById('file-upload');
        const loader = document.getElementById('loader');
        const resultDisplay = document.getElementById('result-display');
        const scanPrompt = document.getElementById('scan-prompt');
        const homeResultDisplay = document.getElementById('home-result-display');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const homeLoader = document.getElementById('home-loader');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const historyModal = document.getElementById('history-modal');
        const modalResultDisplay = document.getElementById('modal-result-display');
        const closeModalBtn = document.querySelector('.close-btn');
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const refreshProfileBtn = document.getElementById('refresh-profile-btn');
        const b50Button = document.getElementById('b50-button-home');
        const b50Modal = document.getElementById('b50-modal');
        const b50Container = document.getElementById('b50-container');
        const b15Grid = document.getElementById('b15-grid');
        const b35Grid = document.getElementById('b35-grid');
        const b50Loader = document.getElementById('b50-loader');
        const b50CloseBtn = b50Modal.querySelector('.close-btn');
        const favoritesButtonHome = document.getElementById('favorites-button-home');
        const favoritesModal = document.getElementById('favorites-modal');
        const favoritesListContainer = document.getElementById('favorites-list-container');
        const favoritesCloseBtn = favoritesModal.querySelector('.close-btn');
        // **ç•™è¨€æ¿æ”¹é€ **: è·å–æ–°å…ƒç´ 
        const feedbackButtonHome = document.getElementById('feedback-button-home');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackCloseBtn = feedbackModal.querySelector('.close-btn');
        // **ç»ˆæäº¤äº’å‡çº§**: è‡ªå®šä¹‰å¼¹çª—å…ƒç´ 
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertCloseBtn = document.getElementById('custom-alert-close-btn');
        let customAlertCallback = null;

        // --- è·¯ç”±å’Œé¡µé¢åˆ‡æ¢é€»è¾‘ ---
        function navigateTo(pageId) {
            // æ›´æ–°URLçš„hash
            window.location.hash = pageId;
            
            // åˆ‡æ¢é¡µé¢æ˜¾ç¤º
            pages.forEach(page => {
                page.classList.toggle('active', page.id === `page-${pageId}`);
            });

            // æ›´æ–°å¯¼èˆªæŒ‰é’®é«˜äº®
            navButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.page === pageId);
            });

        // **ç»ˆææ”¹é€ **: å¦‚æœåˆ‡æ¢åˆ°ä¸ªäººèµ„æ–™é¡µï¼Œåˆ™åŠ è½½æ•°æ® (ä»ç¼“å­˜)
        if (pageId === 'profile') {
            loadProfileData(); // é»˜è®¤ä»ç¼“å­˜åŠ è½½
        }
        }

        // --- äº‹ä»¶ç›‘å¬ ---
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const pageId = button.dataset.page;
                if (pageId === 'scan') {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æ‰«ææŒ‰é’®ï¼Œç›´æ¥è§¦å‘æ–‡ä»¶é€‰æ‹©
                    fileInput.click();
                } else {
                    navigateTo(pageId);
                }
            });
        });

        // ç›‘å¬URL hashçš„å˜åŒ– (ä¾‹å¦‚ï¼Œç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨çš„å‰è¿›/åé€€æŒ‰é’®)
        window.addEventListener('hashchange', () => {
            const pageId = window.location.hash.substring(1) || 'home';
            navigateTo(pageId);
        });

        // é¡µé¢åˆå§‹åŠ è½½æ—¶ï¼Œæ ¹æ®hashç¡®å®šæ˜¾ç¤ºå“ªä¸ªé¡µé¢
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
        // **ç»ˆææ”¹é€ **: æ£€æŸ¥ç™»å½•åç«‹å³å°è¯•åŠ è½½ä¸ªäººèµ„æ–™ (ä»ç¼“å­˜)ï¼Œä»¥ä¾¿åœ¨ä¸»é¡µæ˜¾ç¤ºRating
        if (localStorage.getItem('session_token')) {
            loadProfileData(); // é»˜è®¤ä»ç¼“å­˜åŠ è½½
        }
            const initialPage = window.location.hash.substring(1) || 'home';
            navigateTo(initialPage);
            renderHistoryPage();
        });

        // --- **æ–°å¢**: ä¸»é¡µæœç´¢é€»è¾‘ ---
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            // **ç»ˆæç¼“å­˜æ¶æ„**: IDæœç´¢ä¼˜å…ˆæŸ¥è¯¢æœ¬åœ°æ•°æ®åº“
            if (/^\d+$/.test(query)) {
                const cachedSongArray = getSongFromDatabase(query);
                if (cachedSongArray) {
                    console.log(`[ç¼“å­˜å‘½ä¸­] ä»æœ¬åœ°æ•°æ®åº“åŠ è½½æ­Œæ›²ID: ${query}`);
                    homeLoader.style.display = 'none'; // ç¡®ä¿åŠ è½½åŠ¨ç”»è¢«éšè—
                    historyModal.style.display = 'block';
                    // æ³¨æ„ï¼šä»ç¼“å­˜åŠ è½½æ—¶ï¼Œæˆ‘ä»¬ä¸çŸ¥é“ç”¨æˆ·çš„æœ€æ–°æˆç»©ï¼Œæ‰€ä»¥ä¼ nullè®©displayResultå»è·å–
                    await displayResult(cachedSongArray, modalResultDisplay, true, null);
                    return; // å‘½ä¸­ç¼“å­˜ï¼Œç»ˆæ­¢æ‰§è¡Œ
                }
            }

            homeLoader.style.display = 'block';
            
            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query }),
                });

                const result = await response.json();

                if (response.ok) {
                    // **ç»ˆææ”¹é€ **: åœ¨å¼¹çª—ä¸­æ˜¾ç¤ºç»“æœ
                    historyModal.style.display = 'block';
                    await displayResult(result, modalResultDisplay, true); // ç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯æœç´¢ç»“æœ
                } else {
                    alert(result.error || 'æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚');
            } finally {
                homeLoader.style.display = 'none';
            }
        }

        // --- æ–‡ä»¶ä¸Šä¼ å’Œå¤„ç†é€»è¾‘ ---
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                // åˆ‡æ¢åˆ°æ‰«æé¡µé¢å¹¶å¼€å§‹å¤„ç†
                navigateTo('scan');
                handleSubmit();
            }
        });

        async function handleSubmit() {
            const maxRetries = 3;
            let attempt = 0;

            // UIå‡†å¤‡
            loader.style.display = 'block';
            resultDisplay.innerHTML = '';
            scanPrompt.style.display = 'none';

            while (attempt < maxRetries) {
                attempt++;
                console.log(`Attempt ${attempt}...`);
                try {
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);

                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        if (result.error) {
                            if (attempt >= maxRetries) {
                                displayError(result.error, result.details);
                                break;
                            }
                        } else {
                            // **ä¸ªæ€§åŒ–æ”¹é€ **: displayResultç°åœ¨æ˜¯asyncå¹¶ä¸”ä¼šå¤„ç†å†å²ä¿å­˜
                            await displayResult(result); 
                            return; // æˆåŠŸåç›´æ¥é€€å‡º
                        }
                    } else {
                        if (attempt >= maxRetries) {
                            displayError('æœåŠ¡å™¨é”™è¯¯', `Status: ${response.status}`);
                            break;
                        }
                    }
                    
                    console.log(`Attempt ${attempt} failed, retrying...`);
                    await new Promise(resolve => setTimeout(resolve, 500));

                } catch (error) {
                    if (attempt >= maxRetries) {
                        displayError('ä¸Šä¼ å¤±è´¥', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚');
                        break;
                    }
                    console.log(`Attempt ${attempt} failed with network error, retrying...`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            // æ‰€æœ‰å°è¯•éƒ½å¤±è´¥å
            loader.style.display = 'none';
        }

        // --- å…¨æ–°UIé‡æ„: ç»“æœæ˜¾ç¤ºå‡½æ•° ---
        // å°†æ•°æ®å­˜å‚¨åœ¨windowå¯¹è±¡ä¸Šï¼Œä»¥ä¾¿åç»­å‡½æ•°è®¿é—®
        window.currentSongData = null;
        window.currentScoresMap = null;

        // --- **æ–°å¢**: DXåˆ†æ•°æ˜Ÿçº§è¯„å®š ---
        function getDxStars(dxScore, maxDxScore) {
            if (!maxDxScore || maxDxScore === 0) {
                return '';
            }
            const percentage = (dxScore / maxDxScore) * 100;
            let starsHtml = '';
            let starColor = '';

            if (percentage >= 97) {
                starColor = '#ffc107'; // 5 Stars - Yellow
                starsHtml = 'â˜…â˜…â˜…â˜…â˜…';
            } else if (percentage >= 95) {
                starColor = '#f9a825'; // 4 Stars - Orange
                starsHtml = 'â˜…â˜…â˜…â˜…';
            } else if (percentage >= 93) {
                starColor = '#f9a825'; // 3 Stars - Orange
                starsHtml = 'â˜…â˜…â˜…';
            } else if (percentage >= 90) {
                starColor = '#2dbd64'; // 2 Stars - Green
                starsHtml = 'â˜…â˜…';
            } else if (percentage >= 85) {
                starColor = '#2dbd64'; // 1 Star - Green
                starsHtml = 'â˜…';
            } else {
                return ''; // No stars below 85%
            }

            return `<span class="dx-stars" style="color: ${starColor}; margin-left: 10px; font-size: 18px; vertical-align: middle;">${starsHtml}</span>`;
        }

        async function selectDifficulty(songType, chartIndex, containerElement) {
            // **ç»ˆæDOMä½œç”¨åŸŸä¿®å¤**: æ‰€æœ‰é€‰æ‹©å™¨éƒ½åŸºäºä¼ å…¥çš„å®¹å™¨
            // 1. æ›´æ–°æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            containerElement.querySelectorAll('.difficulty-selector button').forEach(btn => btn.classList.remove('active'));
            const button = containerElement.querySelector(`.difficulty-selector button[data-song-type="${songType}"][data-chart-index="${chartIndex}"]`);
            if (button) {
                button.classList.add('active');
            }

            // 2. ä»å…¨å±€å˜é‡ä¸­è·å–æ‰€éœ€æ•°æ®
            const songData = window.currentSongData.find(s => s.type === songType);
            if (!songData) return;

            const chart = {
                ds: songData.ds[chartIndex],
                charter: songData.charts[chartIndex].charter,
                notes: songData.charts[chartIndex].notes,
            };
            const score = window.currentScoresMap.get(`${songType}-${chartIndex}`);

            // 3. æ¸²æŸ“è°±é¢è¯¦æƒ…å¡ç‰‡ (åŠ¨æ€ç”ŸæˆNoteç½‘æ ¼)
            const chartDetailsDisplay = containerElement.querySelector('#chart-details-display');
            
            const notes = chart.notes;
            let notesGridHtml = '<div class="notes-grid">';
            // é€šç”¨ Note: TAP, HOLD, SLIDE
            notesGridHtml += `<div class="item"><div class="label">TAP</div><div class="value">${notes[0] || 0}</div></div>`;
            notesGridHtml += `<div class="item"><div class="label">HOLD</div><div class="value">${notes[1] || 0}</div></div>`;
            notesGridHtml += `<div class="item"><div class="label">SLIDE</div><div class="value">${notes[2] || 0}</div></div>`;

            // BREAK Note (SDå’ŒDXéƒ½åœ¨ç´¢å¼•3)
            const breakValue = notes[3] || 0;
            if (breakValue > 0) {
                notesGridHtml += `<div class="item"><div class="label">BREAK</div><div class="value">${breakValue}</div></div>`;
            }

            // TOUCH Note (ä»…DXåœ¨ç´¢å¼•4)
            if (songData.type === 'DX') {
                const touchValue = notes[4] || 0;
                if (touchValue > 0) {
                    notesGridHtml += `<div class="item"><div class="label">TOUCH</div><div class="value">${touchValue}</div></div>`;
                }
            }
            notesGridHtml += '</div>';

            chartDetailsDisplay.innerHTML = `
                <div class="details-card">
                    <div class="details-grid">
                        <div class="item">
                            <div class="label">å®˜æ–¹å®šæ•°</div>
                            <div class="value">${chart.ds}</div>
                        </div>
                        <div class="item">
                            <div class="label">è°±é¢è°±å¸ˆ</div>
                            <div class="value">${chart.charter}</div>
                        </div>
                    </div>
                    ${notesGridHtml}
                </div>
            `;

            // 4. æ¸²æŸ“ç©å®¶æˆç»©å¡ç‰‡
            const playerScoreDisplay = containerElement.querySelector('#player-score-display');
            if (score) {
                const dxStarsHtml = getDxStars(score.dxScore, score.maxDxScore);
                // **V5ä¿®æ­£**: å°†æ”¶è—æŒ‰é’®ç§»åŠ¨åˆ°æˆç»©å¡ç‰‡å†…éƒ¨
                playerScoreDisplay.innerHTML = `
                    <div class="details-card player-score-card">
                        <span class="favorite-btn ${isFavorited(window.currentSongData[0].id) ? 'favorited' : ''}" data-song-id="${window.currentSongData[0].id}">â˜…</span>
                        <div>
                            <div class="player-score-card .label" style="font-size:14px; color:var(--text-light);">ç©å®¶æœ€ä½³æˆç»©</div>
                            <div class="score-value">${score.achievements.toFixed(4)}%</div>
                            <div class="dx-score-display" style="font-size: 16px; color: #555; margin-top: 5px; display: flex; align-items: center;">
                                <span>DX Score: <span style="font-weight: bold;">${score.dxScore}</span> / ${score.maxDxScore}</span>
                                ${dxStarsHtml}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                 playerScoreDisplay.innerHTML = ``; // æœªæ¸¸ç©åˆ™ä¸æ˜¾ç¤ºæˆç»©å¡ç‰‡
            }

            // 5. æ¸²æŸ“åˆ†æ•°è¯¦æƒ…è¡¨
            await renderScoreDetailTable(songData, chartIndex, score, containerElement);
        }

        // --- **æœ€ç»ˆç‰ˆæ ¸å¿ƒåŠŸèƒ½**: â€œæ¨åˆ†â€è®¡ç®—é€»è¾‘ (V4 - å¢åŠ æ—¥å¿—ç›‘æ§) ---
        async function renderScoreDetailTable(songData, chartIndex, playerScore, containerElement) {
            console.clear(); // æ¸…ç©ºæ§åˆ¶å°ï¼Œæ–¹ä¾¿æŸ¥çœ‹æœ¬æ¬¡æ—¥å¿—
            console.log("--- å¼€å§‹æ¸²æŸ“åˆ†æ•°è¯¦æƒ…è¡¨ ---");
            console.log("è¾“å…¥ - æ­Œæ›²æ•°æ®:", songData);
            console.log(`è¾“å…¥ - è°±é¢ç´¢å¼•: ${chartIndex}, å®šæ•°: ${songData.ds[chartIndex]}`);
            console.log("è¾“å…¥ - ç©å®¶æˆç»©:", playerScore);

            const tableContainer = containerElement.querySelector('#score-table-display');
            const chartConstant = songData.ds[chartIndex];
            const songId = songData.id;

            // **æœ€ç»ˆå†³å®šæ€§ä¿®æ­£ (V2)**: æ ¹æ®ç”¨æˆ·çš„æœ€ç»ˆæŒ‡ç¤ºï¼Œåªæœ‰ "PRiSM" ä¸€ä¸ªç‰ˆæœ¬ç®—ä½œæ–°æ­Œ
            const newSongVersions = ["maimai ã§ã‚‰ã£ãã™ PRiSM"];
            const isNewSong = newSongVersions.includes(songData.basic_info.from);
            
            console.log(`åˆ¤æ–­ - æ­Œæ›²ID: ${songId}, ç‰ˆæœ¬: "${songData.basic_info.from}", æ˜¯å¦ä¸ºæ–°æ­Œ: ${isNewSong}`);

            const ranks = [
                { name: 'SSS+', achievement: 100.5000 },
                { name: 'SSS',  achievement: 100.0000 },
                { name: 'SS+',  achievement: 99.5000 },
                { name: 'SS',   achievement: 99.0000 },
                { name: 'S+',   achievement: 98.0000 },
                { name: 'S',    achievement: 97.0000 }
            ];

            // 1. **ç»ˆæå¥å£®æ€§ä¿®å¤**: ä½¿ç”¨fetchWithAuthè·å–B50æ•°æ®
            let b50Data = null;
            if (localStorage.getItem('session_token')) {
                try {
                    const response = await fetchWithAuth('/api/b50');
                    if (response.ok) {
                        b50Data = await response.json();
                        console.log("æ—¥å¿— - æˆåŠŸè·å–B50æ•°æ®:", b50Data);
                    } else {
                        b50Data = null;
                    }
                } catch (e) {
                    console.error("æ—¥å¿— - è·å–B50æ—¶å‘ç”Ÿé”™è¯¯:", e.message);
                    b50Data = null;
                }
            } else {
                console.log("æ—¥å¿— - æœªç™»å½•, è·³è¿‡B50è·å–ã€‚");
            }

            // 2. **æ ¸å¿ƒé€»è¾‘é‡æ„**: é‡æ–°å®šä¹‰åŸºå‡†åˆ†(baseRa)çš„ç¡®å®šæ–¹å¼
            let baseRa = 0;
            if (b50Data) {
                const b35 = b50Data.b35 || [];
                const b15 = b50Data.b15 || [];
                
                console.log(`æ—¥å¿— - å¼€å§‹åœ¨B50ä¸­æŸ¥æ‰¾: song_id=${songId}, level_index=${chartIndex}`);
                const songInB50 = [...b15, ...b35].find(s => s.song_id == songId && s.level_index === chartIndex);

                if (songInB50) {
                    baseRa = songInB50.ra;
                    console.log(`æ—¥å¿— - **å‘½ä¸­**: æ­Œæ›²åœ¨B50ä¸­æ‰¾åˆ°ã€‚åŸºå‡†åˆ†(baseRa)è®¾ç½®ä¸ºæ­Œæ›²å½“å‰çš„ra: ${baseRa}`, songInB50);
                } else {
                    console.log("æ—¥å¿— - **æœªå‘½ä¸­**: æ­Œæ›²ä¸åœ¨B50ä¸­ã€‚");
                    if (isNewSong) {
                        if (b15.length > 0) {
                            baseRa = b15[b15.length - 1].ra;
                            console.log(`æ—¥å¿— - ä½¿ç”¨B15æœ€ä½åˆ†ä½œä¸ºåŸºå‡†åˆ†(baseRa): ${baseRa}`);
                        } else {
                            console.log("æ—¥å¿— - B15åˆ—è¡¨ä¸ºç©º, æ— æ³•è®¾ç½®åŸºå‡†åˆ†ã€‚");
                        }
                    } else {
                        if (b35.length > 0) {
                            baseRa = b35[b35.length - 1].ra;
                            console.log(`æ—¥å¿— - ä½¿ç”¨B35æœ€ä½åˆ†ä½œä¸ºåŸºå‡†åˆ†(baseRa): ${baseRa}`);
                        } else {
                            console.log("æ—¥å¿— - B35åˆ—è¡¨ä¸ºç©º, æ— æ³•è®¾ç½®åŸºå‡†åˆ†ã€‚");
                        }
                    }
                }
            } else {
                console.log("æ—¥å¿— - æ— B50æ•°æ®, æ— æ³•è®¡ç®—åŸºå‡†åˆ†ã€‚");
            }
            console.log(`--- åŸºå‡†åˆ†(baseRa)æœ€ç»ˆç¡®å®šä¸º: ${baseRa} ---`);

            // 3. æ¸²æŸ“è¡¨æ ¼
            let theoreticalRaRow = '<tr><td class="difficulty-cell">ç†è®ºå€¼</td>';
            let gainRow = '<tr><td class="difficulty-cell">æ¨åˆ†</td>';

            console.log("--- å¼€å§‹è®¡ç®—å„è¯„çº§æ¨åˆ† ---");
            ranks.forEach(rank => {
                const theoreticalRa = calculateDxRating(chartConstant, rank.achievement);
                theoreticalRaRow += `<td>${theoreticalRa}</td>`;

                if (baseRa > 0) {
                    const gain = theoreticalRa - baseRa;
                    console.log(`è®¡ç®— - ${rank.name}: ç†è®ºåˆ† ${theoreticalRa} - åŸºå‡†åˆ† ${baseRa} = æ¨åˆ† ${gain}`);
                    // **ç»ˆæå¥å£®æ€§ä¿®å¤**: æ˜ç¡®å¤„ç†gainä¸ºæ­£æ•°å’Œéæ­£æ•°ä¸¤ç§æƒ…å†µï¼Œé˜²æ­¢UIå¡æ­»
                    if (gain > 0) {
                        gainRow += `<td class="player-score-highlight"><span class="gain">(+${gain})</span></td>`;
                    } else {
                        gainRow += `<td><span style="color: #aaa;">--</span></td>`;
                    }
                } else {
                    console.log(`è®¡ç®— - ${rank.name}: æ— æœ‰æ•ˆåŸºå‡†åˆ†, æ— æ³•è®¡ç®—æ¨åˆ†ã€‚`);
                    gainRow += `<td><span style="color: #aaa;">(N/A)</span></td>`;
                }
            });

            theoreticalRaRow += '</tr>';
            gainRow += '</tr>';

            // **UIä¼˜åŒ–**: å¢åŠ è¯„çº§è¡¨å¤´
            let headerRow = '<thead><tr><th></th>'; // ç¬¬ä¸€åˆ—ç•™ç©º
            ranks.forEach(rank => {
                headerRow += `<th>${rank.name}</th>`;
            });
            headerRow += '</tr></thead>';

            const tableHtml = `
                <div class="score-table-container">
                    <table class="score-table">
                        ${headerRow}
                        <tbody>
                            ${theoreticalRaRow}
                            ${gainRow}
                        </tbody>
                    </table>
                </div>
            `;
            tableContainer.innerHTML = tableHtml;
        }

        function getScoreMultiplier(achievement) {
            const p = achievement;
            if (p >= 100.5) return 0.224;
            if (p >= 100.0) return 0.216 + (p - 100.0) * (0.224 - 0.216) / 0.5; // SSS -> SSS+
            if (p >= 99.5) return 0.211 + (p - 99.5) * (0.216 - 0.211) / 0.5;   // SS+ -> SSS
            if (p >= 99.0) return 0.208 + (p - 99.0) * (0.211 - 0.208) / 0.5;   // SS -> SS+
            if (p >= 98.0) return 0.203 + (p - 98.0) * (0.208 - 0.203) / 1.0;   // S+ -> SS
            if (p >= 97.0) return 0.200 + (p - 97.0) * (0.203 - 0.200) / 1.0;   // S -> S+
            if (p >= 94.0) return 0.168 + (p - 94.0) * (0.200 - 0.168) / 3.0;   // AAA -> S
            if (p >= 90.0) return 0.152 + (p - 90.0) * (0.168 - 0.152) / 4.0;   // AA -> AAA
            if (p >= 80.0) return 0.136 + (p - 80.0) * (0.152 - 0.136) / 10.0;  // A -> AA
            if (p >= 75.0) return 0.120 + (p - 75.0) * (0.136 - 0.120) / 5.0;   // BBB -> A
            if (p >= 70.0) return 0.112 + (p - 70.0) * (0.120 - 0.112) / 5.0;   // BB -> BBB
            if (p >= 60.0) return 0.096 + (p - 60.0) * (0.112 - 0.096) / 10.0;  // B -> BB
            if (p >= 50.0) return 0.080 + (p - 50.0) * (0.096 - 0.080) / 10.0;  // C -> B
            if (p >= 40.0) return 0.064 + (p - 40.0) * (0.080 - 0.064) / 10.0;  // D -> C
            if (p >= 30.0) return 0.048 + (p - 30.0) * (0.064 - 0.048) / 10.0;
            if (p >= 20.0) return 0.032 + (p - 20.0) * (0.048 - 0.032) / 10.0;
            if (p >= 10.0) return 0.016 + (p - 10.0) * (0.032 - 0.016) / 10.0;
            return 0;
        }

        function calculateDxRating(chartConstant, achievement) {
            // **æ ¸å¿ƒç®—æ³•ä¿®æ­£**: ä»»ä½•è¶…è¿‡100.5%çš„æˆç»©ï¼Œåœ¨è®¡ç®—Ratingæ—¶éƒ½æŒ‰100.5%è®¡ç®—
            const p_calc = Math.min(achievement, 100.5);
            const multiplier = getScoreMultiplier(p_calc);
            const rating = chartConstant * p_calc * multiplier;
            return Math.floor(rating);
        }

        async function displayResult(dataArray, targetElement = resultDisplay, isSearchResult = false, scoresFromHistory = null) {
            // é˜¶æ®µ1: UIå‡†å¤‡å’Œæ•°æ®é¢„å¤„ç†
            if (targetElement === resultDisplay) loader.style.display = 'none';
            if (targetElement === homeResultDisplay) homeLoader.style.display = 'none';

            if (!dataArray || dataArray.length === 0) {
                displayError('è¿”å›æ•°æ®æ— æ•ˆ', 'æœåŠ¡å™¨è¿”å›äº†ç©ºçš„ç»“æœã€‚', targetElement);
                return;
            }
            
            window.currentSongData = dataArray;
            const firstSong = dataArray[0];
            const commonInfo = firstSong.basic_info;
            const coverUrl = firstSong.cover_url;

            // é˜¶æ®µ2: è·å–æˆç»©
            let scoresData = scoresFromHistory;
            if (scoresData === null || typeof scoresData === 'undefined') {
                if (localStorage.getItem('session_token')) {
                    try {
                        const scoreResponse = await fetchWithAuth('/api/player_score', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ song_id: firstSong.id })
                        });
                        scoresData = scoreResponse.ok ? await scoreResponse.json() : [];
                    } catch (e) {
                        console.error("æŸ¥è¯¢æˆç»©å¤±è´¥:", e.message);
                        scoresData = [];
                    }
                } else {
                    scoresData = [];
                }
            }
            
            const scoresMap = new Map();
            if (scoresData && scoresData.length > 0) {
                scoresData.forEach(score => scoresMap.set(`${score.type}-${score.level_index}`, score));
            }
            window.currentScoresMap = scoresMap;

            saveSongArrayToDatabase(dataArray);

            // é˜¶æ®µ3: ç”Ÿæˆé™æ€æ¡†æ¶HTML
            const difficultyLevels = ['Basic', 'Advan', 'Expert', 'Master', 'Re:Mas'];
            const difficultyClasses = ['basic', 'advanced', 'expert', 'master', 'remaster'];
            let difficultyButtonsHtml = '';
            let initialSelect = { songType: null, chartIndex: -1, hasPlayed: false, highestDS: -1 };

            dataArray.forEach(songData => {
                songData.ds.forEach((level, index) => {
                    const hasScore = scoresMap.has(`${songData.type}-${index}`);
                    // **ç»ˆææ—¶åºä¿®å¤**: ç§»é™¤å†…è”onclickï¼Œä¸ºäº‹ä»¶å§”æ‰˜åšå‡†å¤‡
                    difficultyButtonsHtml += `
                        <button class="${difficultyClasses[index]}" data-song-type="${songData.type}" data-chart-index="${index}">
                            ${difficultyLevels[index]}<br>${level}
                        </button>`;
                    
                    if (hasScore && level > initialSelect.highestDS) {
                        initialSelect = { songType: songData.type, chartIndex: index, hasPlayed: true, highestDS: level };
                    } else if (!initialSelect.hasPlayed && level > initialSelect.highestDS) {
                        initialSelect = { songType: songData.type, chartIndex: index, hasPlayed: false, highestDS: level };
                    }
                });
            });

            const finalHtml = `
                <div class="song-details-container">
                    <div class="song-header">
                        <img src="${coverUrl}" class="cover" onerror="this.onerror=null;this.src='/image/404/404.png';">
                        <div class="info">
                            <div>
                                <div class="title-id">#${firstSong.id}</div>
                                <div class="title">${commonInfo.title}</div>
                            </div>
                            <div class="basic-info">
                                BPM: ${commonInfo.bpm} | ç‰ˆæœ¬: ${commonInfo.from}
                            </div>
                        </div>
                    </div>
                    <div class="difficulty-selector">${difficultyButtonsHtml}</div>
                    <div id="chart-details-display"></div>
                    <div id="player-score-display"></div>
                    <div id="score-table-display"></div>
                    <div class="action-buttons" style="margin-top: 15px;">
                        <a href="https://search.bilibili.com/all?keyword=maimai%20${encodeURIComponent(commonInfo.title)}" target="_blank">è·³è½¬Bç«™çœ‹è°±</a>
                        <button disabled>æŸ¥çœ‹åˆ«å</button>
                    </div>
                </div>
            `;
            targetElement.innerHTML = finalHtml;

            // **ç»ˆææ—¶åºä¿®å¤**: ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†éš¾åº¦æŒ‰é’®å’Œæ”¶è—æŒ‰é’®ç‚¹å‡»
            const detailsContainer = targetElement.querySelector('.song-details-container');
            if(detailsContainer) {
                detailsContainer.addEventListener('click', (event) => {
                    const target = event.target;
                    // **V5ä¿®æ­£**: æ”¶è—æŒ‰é’®ç°åœ¨ä½äºæˆç»©å¡ç‰‡å†…ï¼Œä½†äº‹ä»¶å§”æ‰˜ä»åœ¨çˆ¶å®¹å™¨ä¸Š
                    if (target.classList.contains('favorite-btn')) {
                        toggleFavorite(target.dataset.songId, target);
                    } else {
                        const button = target.closest('button');
                        if (button && button.parentElement.classList.contains('difficulty-selector')) {
                            const songType = button.dataset.songType;
                            const chartIndex = parseInt(button.dataset.chartIndex, 10);
                            selectDifficulty(songType, chartIndex, targetElement);
                        }
                    }
                });
            }

            // **ç»ˆææ—¶åºä¿®å¤**: ä½¿ç”¨ requestAnimationFrame ç¡®ä¿DOMæ¸²æŸ“å®Œæ¯•åå†è§¦å‘é»˜è®¤é€‰æ‹©
            if (initialSelect.songType) {
                requestAnimationFrame(async () => {
                    await selectDifficulty(initialSelect.songType, initialSelect.chartIndex, targetElement);
                });
            }

            // é˜¶æ®µ5: ä¿å­˜åˆ°å†å²è®°å½•
            if (!isSearchResult && targetElement === resultDisplay) {
                saveToHistory(dataArray, scoresData);
            }
        }

        function displayError(errorMsg, details, targetElement = resultDisplay) {
            if (targetElement === resultDisplay) {
                loader.style.display = 'none';
            } else if (targetElement === homeResultDisplay) {
                homeLoader.style.display = 'none';
            }
            
            let detailsHtml = '';
            if (errorMsg.includes("æœªèƒ½è¯†åˆ«åˆ°æ­Œæ›²å")) {
                detailsHtml = `<p style="margin-top: 10px;"><small>è¿™å¯èƒ½æ˜¯ç”±äºæ‹æ‘„è§’åº¦ä¸ä½³ã€ç”»é¢æ¨¡ç³Šæˆ–åå…‰å¯¼è‡´çš„ã€‚è¯·æ‚¨è°ƒæ•´åé‡è¯•ã€‚</small></p>`;
            } else if (details) {
                detailsHtml = `<p><small>è¯¦æƒ…: ${details}</small></p>`;
            }
            targetElement.innerHTML = `
                <div class="scan-container" style="padding-top: 20px; padding-bottom: 20px;">
                    <p class="error">${errorMsg}</p>
                    ${detailsHtml}
                </div>
            `;
        }

        // --- **æ–°å¢**: å†å²è®°å½•åŠŸèƒ½ ---
        function getHistory() {
            return JSON.parse(localStorage.getItem('maimaiScanHistory') || '[]');
        }

        function saveHistory(history) {
            localStorage.setItem('maimaiScanHistory', JSON.stringify(history));
        }

        function saveToHistory(dataArray, scoreData = null) {
            const history = getHistory();
            // **ç»ˆæç¼“å­˜æ¶æ„**: å†å²è®°å½•åªä¿å­˜æ­Œæ›²IDå’Œæˆç»©ï¼Œä¸å†é‡å¤å­˜å‚¨æ­Œæ›²æ•°æ®
            const songId = dataArray[0].id;
            const newEntry = {
                timestamp: Date.now(),
                songId: songId, // åªå­˜ID
                score: scoreData 
            };
            history.unshift(newEntry);
            saveHistory(history);
            renderHistoryPage();
        }

        function renderHistoryPage() {
            const history = getHistory();
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--text-light);">æš‚æ— å†å²è®°å½•</p>';
                clearHistoryBtn.style.display = 'none';
                return;
            }

            clearHistoryBtn.style.display = 'block';
            const songDb = getSongDatabase(); // **ç»ˆæç¼“å­˜æ¶æ„**: è·å–ä¸€æ¬¡æ•°æ®åº“ï¼Œé¿å…åœ¨å¾ªç¯ä¸­é‡å¤è¯»å–

            history.forEach(entry => {
                const li = document.createElement('li');
                li.className = 'history-item';
                
                // **ç»ˆæç¼“å­˜æ¶æ„**: ä»æ•°æ®åº“ä¸­è·å–æ­Œæ›²ä¿¡æ¯æ¥æ¸²æŸ“åˆ—è¡¨é¡¹
                const songDataArray = songDb[entry.songId];
                const coverUrl = songDataArray && songDataArray[0] ? songDataArray[0].cover_url : '';
                const title = songDataArray && songDataArray[0] ? songDataArray[0].basic_info.title : `æœªçŸ¥æ­Œæ›² (ID: ${entry.songId})`;

                li.innerHTML = `
                    <img src="${coverUrl}" class="history-item-cover" alt="å°é¢" onerror="this.onerror=null;this.src='/image/404/404.png';">
                    <div class="history-item-info">
                        <div class="title">${title}</div>
                        <div class="time">${new Date(entry.timestamp).toLocaleString()}</div>
                    </div>
                    <div class="history-item-actions">
                        <button onclick="showHistoryDetail(${entry.timestamp})">è¯¦æƒ…</button>
                        <button class="delete-btn" onclick="deleteHistoryItem(${entry.timestamp})">åˆ é™¤</button>
                    </div>
                `;
                historyList.appendChild(li);
            });
        }

        async function showHistoryDetail(timestamp) {
            const history = getHistory();
            const entry = history.find(item => item.timestamp === timestamp);
            if (entry) {
                // **ç»ˆæç¼“å­˜æ¶æ„**: ä»æœ¬åœ°æ•°æ®åº“ä¸­é€šè¿‡IDæ£€ç´¢æ­Œæ›²æ•°æ®
                const songDataArray = getSongFromDatabase(entry.songId);
                if (songDataArray) {
                    historyModal.style.display = 'block';
                    // ä»å†å²è®°å½•ä¸­è¯»å–æˆç»©å¿«ç…§ (entry.score) å¹¶ä¼ é€’ç»™displayResult
                    await displayResult(songDataArray, modalResultDisplay, false, entry.score);
                } else {
                    // è¿™æ˜¯ä¸€ä¸ªå¼‚å¸¸æƒ…å†µï¼Œç†è®ºä¸Šä¸åº”å‘ç”Ÿ
                    alert(`é”™è¯¯ï¼šåœ¨æœ¬åœ°æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°æ­Œæ›²ID ${entry.songId}ã€‚æ•°æ®å¯èƒ½å·²æŸåã€‚`);
                }
            }
        }

        function deleteHistoryItem(timestamp) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            let history = getHistory();
            history = history.filter(item => item.timestamp !== timestamp);
            saveHistory(history);
            renderHistoryPage();
        }

        clearHistoryBtn.addEventListener('click', () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            saveHistory([]);
            renderHistoryPage();
        });

        // --- **æ–°å¢**: å¼¹çª—å…³é—­é€»è¾‘ ---
        closeModalBtn.addEventListener('click', () => {
            historyModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == historyModal) {
                historyModal.style.display = 'none';
            }
            if (event.target == b50Modal) {
                b50Modal.style.display = 'none';
            }
            if (event.target == favoritesModal) {
                favoritesModal.style.display = 'none';
            }
            // **ç•™è¨€æ¿æ”¹é€ **: ç‚¹å‡»å¤–éƒ¨å…³é—­åé¦ˆå¼¹çª—
            if (event.target == feedbackModal) {
                feedbackModal.style.display = 'none';
            }
            // **ç»ˆæäº¤äº’å‡çº§**: ç‚¹å‡»å¼¹çª—å¤–éƒ¨ä¹Ÿå¯å…³é—­
            if (event.target == customAlertModal) {
                customAlertCloseBtn.click();
            }
        });

        // --- **ç»ˆæäº¤äº’å‡çº§**: è‡ªå®šä¹‰å¼¹çª—æ ¸å¿ƒå‡½æ•° ---
        function showCustomAlert(message, callback) {
            customAlertMessage.textContent = message;
            customAlertCallback = callback;
            customAlertModal.style.display = 'block';
        }

        // --- **ç»ˆæå¥å£®æ€§**: å…¨å±€è®¤è¯é”™è¯¯å¤„ç† ---
        function handleUnauthorized() {
            localStorage.removeItem('session_token');
            localStorage.removeItem('maimaiUserProfile');
            document.getElementById('home-rating-display').style.display = 'none';
            document.getElementById('profile-container').innerHTML = '';
            showCustomAlert('ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚', () => {
                loginModal.style.display = 'block';
            });
        }

        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('session_token');
            if (!token) {
                handleUnauthorized();
                throw new Error('No session token found.');
            }

            const headers = {
                ...options.headers,
                'x-access-token': token
            };

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401 || response.status === 403) {
                handleUnauthorized();
                throw new Error('Unauthorized');
            }

            return response;
        }

        customAlertCloseBtn.addEventListener('click', () => {
            customAlertModal.style.display = 'none';
            if (typeof customAlertCallback === 'function') {
                customAlertCallback();
            }
        });

        b50CloseBtn.addEventListener('click', () => {
            b50Modal.style.display = 'none';
        });

        favoritesCloseBtn.addEventListener('click', () => {
            favoritesModal.style.display = 'none';
        });

        favoritesButtonHome.addEventListener('click', (event) => {
            event.stopPropagation();
            renderFavorites();
            favoritesModal.style.display = 'block';
        });

        // **ç•™è¨€æ¿æ”¹é€ **: æ–°å¢äº‹ä»¶ç›‘å¬
        feedbackButtonHome.addEventListener('click', () => {
            feedbackModal.style.display = 'block';
        });

        feedbackCloseBtn.addEventListener('click', () => {
            feedbackModal.style.display = 'none';
        });

        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-feedback-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            const type = document.getElementById('feedback-type').value;
            const content = document.getElementById('feedback-content').value;
            const contact = document.getElementById('feedback-contact').value;

            if (!content.trim()) {
                showCustomAlert('åé¦ˆå†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤åé¦ˆ';
                return;
            }

            try {
                const response = await fetchWithAuth('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, content, contact })
                });
                const result = await response.json();

                if (response.ok) {
                    showCustomAlert(result.message || 'æäº¤æˆåŠŸï¼', () => {
                        feedbackForm.reset();
                        feedbackModal.style.display = 'none';
                    });
                } else {
                    showCustomAlert(result.error || 'æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    showCustomAlert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•æäº¤åé¦ˆã€‚');
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤åé¦ˆ';
            }
        });

        function renderFavorites() {
            const favorites = getFavorites();
            favoritesListContainer.innerHTML = '';

            if (favorites.length === 0) {
                favoritesListContainer.innerHTML = '<p style="text-align: center; color: var(--text-light);">è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ­Œæ›²å“¦</p>';
                return;
            }

            const songDb = getSongDatabase();
            const list = document.createElement('ul');
            list.id = 'history-list'; // Re-use history list styling
            list.style.maxHeight = '60vh';
            list.style.overflowY = 'auto';

            favorites.forEach(songId => {
                const songDataArray = songDb[songId];
                if (songDataArray) {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    const coverUrl = songDataArray[0].cover_url;
                    const title = songDataArray[0].basic_info.title;

                    li.innerHTML = `
                        <img src="${coverUrl}" class="history-item-cover" alt="å°é¢" onerror="this.onerror=null;this.src='/image/404/404.png';">
                        <div class="history-item-info">
                            <div class="title">${title}</div>
                            <div class="time">ID: ${songId}</div>
                        </div>
                        <div class="history-item-actions">
                            <button onclick="showFavoriteDetail('${songId}')">è¯¦æƒ…</button>
                        </div>
                    `;
                    list.appendChild(li);
                }
            });
            favoritesListContainer.appendChild(list);
        }

        async function showFavoriteDetail(songId) {
            const songDataArray = getSongFromDatabase(songId);
            if (songDataArray) {
                favoritesModal.style.display = 'none'; // Close favorites modal
                historyModal.style.display = 'block'; // Open details modal
                await displayResult(songDataArray, modalResultDisplay, true, null);
            }
        }

        // --- **ç»ˆæäº¤äº’å‡çº§**: B50é¡¹ç›®ç‚¹å‡»å¤„ç† (V2: å¢åŠ äº‘ç«¯å›æº) ---
        async function handleB50ItemClick(event) {
            const item = event.target.closest('.b50-item');
            if (!item) return;

            const songId = item.dataset.songId;
            if (!songId) return;

            // 1. ä¼˜å…ˆä»æœ¬åœ°æ•°æ®åº“è·å–æ­Œæ›²æ•°æ®
            let songDataArray = getSongFromDatabase(songId);

            if (songDataArray) {
                // æœ¬åœ°å‘½ä¸­ï¼Œç›´æ¥æ˜¾ç¤º
                console.log(`[B50 ç¼“å­˜å‘½ä¸­] ä»æœ¬åœ°æ•°æ®åº“åŠ è½½æ­Œæ›²ID: ${songId}`);
                b50Modal.style.display = 'none';
                historyModal.style.display = 'block';
                await displayResult(songDataArray, modalResultDisplay, false, null);
            } else {
                // æœ¬åœ°æœªå‘½ä¸­ï¼Œä»æœåŠ¡å™¨å›æºè·å–
                console.log(`[B50 ç¼“å­˜æœªå‘½ä¸­] ä»æœåŠ¡å™¨æ‹‰å–æ­Œæ›²ID: ${songId}`);
                // **ç»ˆæå¥å£®æ€§**: åœ¨B50å¼¹çª—å†…æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                b50Loader.style.display = 'block';
                
                try {
                    const response = await fetch('/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: songId }),
                    });
                    const result = await response.json();

                    if (response.ok) {
                        // æˆåŠŸè·å–æ•°æ®åï¼Œå…³é—­B50ï¼Œæ‰“å¼€è¯¦æƒ…
                        b50Modal.style.display = 'none';
                        historyModal.style.display = 'block';
                        await displayResult(result, modalResultDisplay, false, null);
                    } else {
                        showCustomAlert(result.error || `æœåŠ¡å™¨é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°IDä¸º ${songId} çš„æ­Œæ›²ã€‚`);
                    }
                } catch (error) {
                    showCustomAlert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚');
                } finally {
                    // æ— è®ºæˆåŠŸä¸å¦ï¼Œéšè—åŠ è½½åŠ¨ç”»
                    b50Loader.style.display = 'none';
                }
            }
        }

        b15Grid.addEventListener('click', handleB50ItemClick);
        b35Grid.addEventListener('click', handleB50ItemClick);

        b50Button.addEventListener('click', async (event) => {
            event.stopPropagation();
            b15Grid.innerHTML = '';
            b35Grid.innerHTML = '';
            b50Container.style.display = 'none';
            b50Loader.style.display = 'block';
            b50Modal.style.display = 'block';

            try {
                const response = await fetchWithAuth('/api/b50');
                const data = await response.json();

                if (response.ok) {
                    // **ç»ˆæB50é€»è¾‘é‡æ„**: æ¸²æŸ“å‡½æ•°
                    const renderGrid = (records, rankStart) => {
                        let rank = rankStart;
                        // **ç»ˆæè‰²å½©è°ƒå’Œ**: é‡æ–°å®šä¹‰é¢œè‰²æ•°ç»„ï¼Œå¹¶åº”ç”¨å®Œæ•´çš„è¾¹æ¡†æ ·å¼
                        const difficultyColors = ['#2dbd64', '#f9a825', '#f44336', '#6a1b9a', '#e1bee7'];
                        return records.map(song => {
                            const borderColor = difficultyColors[song.level_index] || 'transparent';
                            // **ç»ˆæå½¢æ€ä¿®æ­£**: å°†æ ·å¼å¼ºåˆ¶åº”ç”¨åˆ°å®Œæ•´çš„ `border-color`
                            const styleAttribute = `border-color: ${borderColor} !important;`;

                            // **ç»ˆæå½¢æ€é”å®š**: ç§»é™¤DXåˆ†æ•°
                            return `
                                <div class="b50-item" style="${styleAttribute}" data-song-id="${song.song_id}">
                                    <div class="b50-item-inner">
                                        <img src="${song.cover_url}" alt="${song.title}" onerror="this.onerror=null;this.src='/image/404/404.png';">
                                        <div class="title">${song.title}</div>
                                        <div class="achievements"><strong>${(song.achievements || 0).toFixed(4)}%</strong></div>
                                        <div class="stats">${song.ds || 'N/A'} -> ${song.ra || 'N/A'}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    };

                    b15Grid.innerHTML = renderGrid(data.b15 || [], 1);
                    b35Grid.innerHTML = renderGrid(data.b35 || [], 1);
                    b50Container.style.display = 'block';

                } else {
                    showCustomAlert(`æŸ¥è¯¢B50å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                    b50Modal.style.display = 'none';
                }
            } catch (error) {
                // fetchWithAuth ä¼šå¤„ç†401/403ï¼Œè¿™é‡Œåªæ•è·å…¶ä»–ç½‘ç»œé”™è¯¯
                if (error.message !== 'Unauthorized') {
                    showCustomAlert('æŸ¥è¯¢B50æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚');
                }
                b50Modal.style.display = 'none';
            } finally {
                b50Loader.style.display = 'none';
            }
        });

        // --- **æ–°å¢**: è®¤è¯ä¸èµ„æ–™åŠŸèƒ½ ---
        function checkLogin() {
            const token = localStorage.getItem('session_token');
            if (!token) {
                loginModal.style.display = 'block';
            } else {
                loginModal.style.display = 'none';
            }
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;
            loginError.style.display = 'none';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('session_token', data.session_token);
                    loginModal.style.display = 'none';
                    // **ç»ˆæäº¤äº’å‡çº§**: ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—å¹¶è®¾ç½®å›è°ƒ
                    showCustomAlert('ç™»å½•æˆåŠŸï¼', () => {
                        location.reload();
                    });
                } else {
                    loginError.textContent = data.error || 'ç™»å½•å¤±è´¥';
                    loginError.style.display = 'block';
                }
            } catch (error) {
                loginError.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                loginError.style.display = 'block';
            }
        });


        const REFRESH_COOLDOWN = 60000; // 60ç§’å†·å´æ—¶é—´

        function startCooldown(button, seconds) {
            button.disabled = true;
            let secondsLeft = seconds;
            button.textContent = `è¯·ç¨å€™ (${secondsLeft}s)`;
            
            const interval = setInterval(() => {
                secondsLeft--;
                if (secondsLeft > 0) {
                    button.textContent = `è¯·ç¨å€™ (${secondsLeft}s)`;
                } else {
                    clearInterval(interval);
                    button.disabled = false;
                    button.textContent = 'æ›´æ–°æ•°æ®';
                }
            }, 1000);
        }

        refreshProfileBtn.addEventListener('click', async () => {
            const lastRefresh = parseInt(localStorage.getItem('lastProfileRefreshTime') || '0');
            const now = Date.now();

            if (now - lastRefresh < REFRESH_COOLDOWN) {
                const secondsLeft = Math.ceil((REFRESH_COOLDOWN - (now - lastRefresh)) / 1000);
                showCustomAlert(`æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·åœ¨ ${secondsLeft} ç§’åé‡è¯•ã€‚`);
                return;
            }

            refreshProfileBtn.disabled = true;
            refreshProfileBtn.textContent = 'æ›´æ–°ä¸­...';

            try {
                const response = await fetchWithAuth('/api/profile/refresh', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('maimaiUserProfile', JSON.stringify(data));
                    renderProfile(data);
                    localStorage.setItem('lastProfileRefreshTime', Date.now().toString());
                    showCustomAlert('ä¸ªäººèµ„æ–™å·²ä»æœåŠ¡å™¨æˆåŠŸæ›´æ–°ï¼');
                    startCooldown(refreshProfileBtn, REFRESH_COOLDOWN / 1000);
                } else {
                    showCustomAlert(`æ›´æ–°å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                    refreshProfileBtn.disabled = false;
                    refreshProfileBtn.textContent = 'æ›´æ–°æ•°æ®';
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    showCustomAlert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•æ›´æ–°æ•°æ®ã€‚');
                }
                refreshProfileBtn.disabled = false;
                refreshProfileBtn.textContent = 'æ›´æ–°æ•°æ®';
            }
        });

        logoutButton.addEventListener('click', async () => {
            if (!localStorage.getItem('session_token')) return;

            try {
                await fetchWithAuth('/api/logout', {
                    method: 'POST'
                });
            } catch (error) {
                console.error("ç™»å‡ºæ—¶å‘ç”Ÿé”™è¯¯:", error.message);
            } finally {
                // handleUnauthorized å·²ç»è¢«è°ƒç”¨ï¼Œè¿™é‡Œåªéœ€æç¤ºç”¨æˆ·
                showCustomAlert('æ‚¨å·²å®‰å…¨ç™»å‡ºã€‚', () => {
                    checkLogin();
                });
            }
        });

        // **ç»ˆæä¿®å¤**: é‡æ–°å®šä¹‰å…¨å±€å¯ç”¨çš„ getRatingText å‡½æ•°
        function getRatingText(rating) {
            const r = parseInt(rating, 10);
            if (r === 0) return "åˆå­¦è€…";
            if (r >= 1 && r <= 10) {
                const levels = ["åˆæ®µ", "äºŒæ®µ", "ä¸‰æ®µ", "å››æ®µ", "äº”æ®µ", "å…­æ®µ", "ä¸ƒæ®µ", "å…«æ®µ", "ä¹æ®µ", "åæ®µ"];
                return levels[r - 1];
            }
            if (r >= 11 && r <= 20) {
                const levels = ["çœŸåˆæ®µ", "çœŸäºŒæ®µ", "çœŸä¸‰æ®µ", "çœŸå››æ®µ", "çœŸäº”æ®µ", "çœŸå…­æ®µ", "çœŸä¸ƒæ®µ", "çœŸå…«æ®µ", "çœŸä¹æ®µ", "çœŸåæ®µ"];
                return levels[r - 11];
            }
            if (r === 21) return "çœŸçš†ä¼ ";
            if (r === 22) return "é‡Œçš†ä¼ ";
            return "æœªçŸ¥æ®µä½";
        }

        // **ç»ˆæè§†è§‰å‡çº§**: æ³¨å…¥åŠ¨æ€æ¸å˜é«˜çº§æ„Ÿ
        function getRatingColor(rating) {
            const r = parseInt(rating, 10);
            if (r >= 15000) return 'linear-gradient(135deg, #ff66ff, #ffc371, #ffff7e, #80ff80, #7fffff, #8080ff, #ff66ff)';
            if (r >= 14500) return 'linear-gradient(135deg, #fff59d, #fdd835, #ffb300)'; // å°Šçˆµé‡‘
            if (r >= 14000) return 'linear-gradient(135deg, #ffca28, #ffb300)'; // ç¥ç€é‡‘
            if (r >= 13000) return 'linear-gradient(135deg, #f5f5f5, #bdbdbd)'; // æµå…‰é“¶
            if (r >= 12000) return 'linear-gradient(135deg, #d7ccc8, #a1887f)'; // é’é“œ
            if (r >= 10000) return '#ab47bc'; // ç´«è‰² (ä¿æŒå•è‰²ä»¥ç¤ºåŒºåˆ«)
            if (r >= 7000) return '#ef5350';  // çº¢è‰²
            if (r >= 4000) return '#ffee58';  // é»„è‰²
            if (r >= 2000) return '#9ccc65';  // ç»¿è‰²
            if (r >= 1000) return '#42a5f5';  // è“è‰²
            return '#eeeeee'; // é»˜è®¤
        }

        // **å®‡å®™ç»ˆæä¿®æ­£**: åŠ¨æ€è®¾ç½®æŒ‰é’®é«˜åº¦çš„å‡½æ•°
        function setFavoriteButtonHeight() {
            const ratingCard = document.getElementById('home-rating-display');
            const favoriteButton = document.getElementById('favorites-button-home');
            const feedbackButton = document.getElementById('feedback-button-home');
            
            if (ratingCard && favoriteButton && feedbackButton && ratingCard.offsetHeight > 0) {
                const height = ratingCard.offsetHeight;
                // **V6ä¿®æ­£**: ç›´æ¥å°†Ratingå¡ç‰‡çš„é«˜åº¦èµ‹ç»™ä¸¤ä¸ªæŒ‰é’®
                favoriteButton.style.height = `${height}px`;
                feedbackButton.style.height = `${height}px`;
                console.log(`[åŠ¨æ€ç­‰é«˜ V2] Ratingå¡ç‰‡é«˜åº¦: ${height}px, å·²åº”ç”¨åˆ°ä¸¤ä¸ªæŒ‰é’®ã€‚`);
            }
        }

        // **ç»ˆææ€§èƒ½ä¼˜åŒ–**: æ¸²æŸ“ä¸ªäººèµ„æ–™çš„ç‹¬ç«‹å‡½æ•°
        function renderProfile(data) {
            const profileContainer = document.getElementById('profile-container');
            const homeRatingDisplay = document.getElementById('home-rating-display');

            // 1. æ›´æ–°ä¸»é¡µRatingç»„ä»¶
            const ratingColor = getRatingColor(data.rating);
            homeRatingDisplay.querySelector('.value').textContent = data.rating;
            let finalStyle = '';
            let textColor = 'white';
            if (['#eeeeee', '#ffee58', '#fdd835', 'linear-gradient(135deg, #f5f5f5, #bdbdbd)', 'linear-gradient(135deg, #d7ccc8, #a1887f)'].includes(ratingColor) || ratingColor.includes('ffff7e')) {
                textColor = '#000000';
            }
            if (ratingColor.startsWith('linear-gradient')) {
                finalStyle = `background: ${ratingColor} !important; color: ${textColor} !important; display: block !important;`;
            } else {
                finalStyle = `background-color: ${ratingColor} !important; background-image: none !important; color: ${textColor} !important; display: block !important;`;
            }
            homeRatingDisplay.setAttribute('style', finalStyle);

            // **å®‡å®™ç»ˆæä¿®æ­£**: åœ¨Ratingå¡ç‰‡æ¸²æŸ“åï¼Œè°ƒç”¨åŠ¨æ€ç­‰é«˜å‡½æ•°
            requestAnimationFrame(setFavoriteButtonHeight);

            // 2. æ›´æ–°â€œæˆ‘çš„â€é¡µé¢
            const ratingText = getRatingText(data.additional_rating);
            profileContainer.innerHTML = `
                <table class="result-table">
                    <tr><td>Rating</td><td>${data.rating}</td></tr>
                    <tr><td>ç”¨æˆ·å</td><td>${data.username}</td></tr>
                    <tr><td>QQ</td><td>${data.bind_qq || 'æœªç»‘å®š'}</td></tr>
                    <tr><td>æ®µä½</td><td>${ratingText} (${data.additional_rating})</td></tr>
                    <tr><td>ç‰Œå­</td><td>${data.plate || 'æœªè®¾ç½®'}</td></tr>
                </table>
            `;
        }

        async function loadProfileData() {
            const token = localStorage.getItem('session_token');
            const profileContainer = document.getElementById('profile-container');
            const homeRatingDisplay = document.getElementById('home-rating-display');
            const cachedProfile = JSON.parse(localStorage.getItem('maimaiUserProfile'));

            if (!token) {
                profileContainer.innerHTML = '<p class="error">è¯·å…ˆç™»å½•ã€‚</p>';
                homeRatingDisplay.style.display = 'none';
                checkLogin();
                return;
            }

            // **æ ¸å¿ƒç¼“å­˜é€»è¾‘**: å¦‚æœæœ‰ç¼“å­˜ï¼Œç›´æ¥ä½¿ç”¨
            if (cachedProfile) {
                console.log("[ç¼“å­˜å‘½ä¸­] ä»æœ¬åœ°åŠ è½½ä¸ªäººèµ„æ–™ã€‚");
                renderProfile(cachedProfile);
                return;
            }

            // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™ä»æœåŠ¡å™¨è·å–ä¸€æ¬¡ï¼ˆä¸ä¼šè§¦å‘DFåˆ·æ–°ï¼‰
            profileContainer.innerHTML = '<p>æ­£åœ¨åŠ è½½...</p>';

            try {
                const response = await fetchWithAuth('/api/profile');
                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('maimaiUserProfile', JSON.stringify(data));
                    renderProfile(data);
                } else {
                    // 401/403é”™è¯¯å·²è¢«å…¨å±€å¤„ç†ï¼Œè¿™é‡Œå¤„ç†å…¶ä»–å¯èƒ½çš„æœåŠ¡å™¨é”™è¯¯
                    profileContainer.innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${data.error || `æœåŠ¡å™¨é”™è¯¯ (çŠ¶æ€: ${response.status})`}</p>`;
                    homeRatingDisplay.style.display = 'none';
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    console.error("ç½‘ç»œé”™è¯¯:", error);
                    profileContainer.innerHTML = `<p class="error">ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½ä¸ªäººèµ„æ–™ã€‚</p>`;
                    homeRatingDisplay.style.display = 'none';
                }
            }
        }

    </script>
</body>
</html>
